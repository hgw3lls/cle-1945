<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Going to the Movies in Cleveland, 1945</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body, html { margin:0; padding:0; height:100%; font-family:Arial, sans-serif; }
    #map { position:absolute; top:0; bottom:0; right:0; left:300px; }
    #sidebar {
      position:absolute; top:0; left:0; bottom:0; width:300px;
      background:#f8f9fa; border-right:1px solid #ddd; overflow:auto; padding:12px;
    }
    #homeBtn {
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid #1d4ed8; background:#2563eb; color:#fff;
      font-weight:700; cursor:pointer;
    }
    #homeBtn:hover { background:#1d4ed8; }
    .section-title { font-weight:bold; margin-top:8px; margin-bottom:6px; }
    .btns button {
      width:100%; padding:8px 10px; margin:4px 0;
      border:1px solid #444; border-radius:6px;
      cursor:pointer; background:#eee;
    }
    .btns button:hover { background:#ddd; }
  </style>
</head>
<body>
  <div id="sidebar">
    <!-- Home button -->
    <div style="margin-bottom:12px;">
      <button id="homeBtn">Home View</button>
    </div>

    <!-- Intro -->
    <div style="font-size:14px; line-height:1.4; margin-bottom:12px; color:#333;">
  It&rsquo;s August 1945. The war is ending, the lights are back on downtown, and Cleveland&rsquo;s theaters are buzzing with crowds.
  This interactive map lets you relive that moment.<br><br>
  Just tap a theater dot to see what was on the marquee: the films playing that week, the house itself, and&mdash;when available&mdash;a photo, address, and a bit of its history.<br><br>
  Close the window to return to the map and stroll to the next showplace. When your tour is done, step back to the map&rsquo;s beginning and imagine the city as it was&mdash;alive with moviegoing.
</div>

    <!-- Cache buttons -->
    <div class="btns">
      <button id="seedView">Save tiles in view</button>
      <button id="clearCache">Clear tile cache</button>
    </div>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Axios for fetch (used by cached layer polyfill) -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
  // --------- Base map init ----------
  const HOME_CENTER = [41.4993, -81.6944];
  const HOME_ZOOM = 13;

  const map = L.map('map').setView(HOME_CENTER, HOME_ZOOM);

  // Hybrid layers: imagery + labels + roads
  const imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19
  });
  const refLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19
  });
  const refRoads = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19
  });
  const hybrid = L.layerGroup([imagery, refLabels, refRoads]);

  const streets = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19
  });

  hybrid.addTo(map);

  L.control.layers(
    { "Hybrid (Imagery + Labels)": hybrid, "Streets": streets },
    null,
    { collapsed:false }
  ).addTo(map);

  // Home button resets view
  document.getElementById('homeBtn').addEventListener('click', () => {
    map.setView(HOME_CENTER, HOME_ZOOM);
    map.closePopup();
  });
  </script>

  <!-- Service Worker registration + fix scripts -->
  <script>
  // ---------- Protocol check & UI notice ----------
  (function(){
    function ensureNotice(){
      var sb = document.getElementById('sidebar');
      if (!sb) return;
      var note = document.createElement('div');
      note.id = 'swNotice';
      note.style.cssText = 'font-size:12px;background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:8px;border-radius:8px;margin-bottom:8px;display:none;';
      note.innerHTML = '<b>Offline caching disabled:</b> This page is opened via <code>file://</code>. Run a local server (e.g., <code>python -m http.server 5500</code>) and open <code>http://localhost:5500</code> to enable Service Worker tile caching.';
      sb.insertBefore(note, sb.firstChild);
    }
    function showNotice(show){
      var n = document.getElementById('swNotice');
      if (n) n.style.display = show ? 'block' : 'none';
    }
    function disableSeedButtons(disabled){
      var seed = document.getElementById('seedView');
      if (seed) { seed.disabled = disabled; seed.title = disabled ? 'Enable by serving over http:// or https://' : ''; }
    }
    ensureNotice();
    var isHttp = location.protocol === 'http:' || location.protocol === 'https:';
    if (!isHttp) { showNotice(true); disableSeedButtons(true); }
    window._isHttp = isHttp;
  })();

  // ---------- Robust map detection ----------
  function getMapRef(){
    if (window.map && typeof window.map.getZoom === 'function' && window.map instanceof L.Map) return window.map;
    if (window._map && typeof window._map.getZoom === 'function' && window._map instanceof L.Map) return window._map;
    for (const k in window){
      try{
        const v = window[k];
        if (v && typeof v.getZoom === 'function' && typeof v.getBounds === 'function' && typeof v.setView === 'function') {
          return v;
        }
      } catch(e){}
    }
    return null;
  }

  // ---------- SW registration ----------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('./sw-cle-tiles.js').then(function(reg) {
        console.log('ServiceWorker registered:', reg.scope);
      }).catch(function(err) {
        console.warn('ServiceWorker registration failed:', err);
      });
    });
  }

  // ---------- Seed button ----------
  document.addEventListener('DOMContentLoaded', function(){
    var seedBtn = document.getElementById('seedView');
    if (!seedBtn) return;
    seedBtn.addEventListener('click', async function(){
      var m = getMapRef();
      if (!m || typeof m.getZoom !== 'function') {
        return alert('Map not ready yet. Try again in a moment.');
      }
      if (!window._isHttp) {
        return alert('To cache tiles, run this page over http(s). See the yellow notice at the top of the sidebar.');
      }
      try{
        const z = Math.max(0, Math.floor(m.getZoom()));
        const b = m.getBounds();
        const layers = [];
        m.eachLayer(function(l){
          if (l instanceof L.TileLayer && typeof l.getTileUrl === 'function') layers.push(l);
        });
        if (!layers.length) return alert('No basemap layers active to cache.');
        const urls = [];
        for (let Z=z; Z<=Math.min(z+2, 19); Z++){
          const nw = m.project(b.getNorthWest(), Z).divideBy(256).floor();
          const se = m.project(b.getSouthEast(), Z).divideBy(256).floor();
          for (let x=nw.x; x<=se.x; x++){
            for (let y=nw.y; y<=se.y; y++){
              for (const l of layers){
                let u = l.getTileUrl({x,y,z:Z});
                if (u.indexOf('{s}') !== -1) u = u.replace('{s}', 'a');
                urls.push(u);
              }
            }
          }
        }
        if (!urls.length) return alert('Computed 0 tile URLs for this view.');
        seedBtn.disabled = true; seedBtn.textContent = 'Seeding...';
        await Promise.all(urls.map(u => fetch(u, { mode:'no-cors', cache:'reload' }).catch(()=>null)));
        alert('Requested ~' + urls.length + ' tiles for caching (zoom ' + z + ' to ' + Math.min(z+2,19) + ').');
      } catch(e){
        console.error(e);
        alert('Seeding failed: ' + (e && e.message ? e.message : e));
      } finally {
        seedBtn.disabled = false; seedBtn.textContent = 'Save tiles in view';
      }
    });
  });
  </script>
</body>
</html>

