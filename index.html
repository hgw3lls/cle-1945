<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Going to the Movies in Cleveland, 1945</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { margin:0; padding:0; height:100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    #map { position:absolute; top:0; bottom:0; right:0; left:360px; }
    #sidebar {
      position:absolute; top:0; left:0; bottom:0; width:360px;
      background:#f8f9fa; border-right:1px solid #ddd; overflow:auto; padding:12px;
    }
    #homeBtn {
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid #1d4ed8; background:#2563eb; color:#fff;
      font-weight:700; cursor:pointer;
    }
    #homeBtn:hover { background:#1d4ed8; }
    .section-title { font-weight:700; text-transform:uppercase; font-size:12px; letter-spacing:.05em; margin:12px 0 6px; color:#333; }
    .btns button {
      width:100%; padding:8px 10px; margin:4px 0;
      border:1px solid #444; border-radius:8px;
      cursor:pointer; background:#eee;
    }
    .btns button:hover { background:#ddd; }
    .search { width:100%; box-sizing:border-box; padding:8px 10px; border-radius:8px; border:1px solid #ccc; margin-bottom:8px; }
    .status { font-size:12px; color:#333; margin:8px 0; }
    .list { margin-top:6px; }
    .item { padding:8px; border-radius:8px; border:1px solid #eee; margin-bottom:6px; cursor:pointer; background:#fff; }
    .item:hover { background:#f3f4f6; }
    .title { font-weight:700; }
    .small { color:#555; font-size:12px; }
    .badges { display:flex; flex-wrap:wrap; gap:6px; margin-top:4px; }
    .badge { display:inline-block; padding:2px 6px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe; font-size:11px; color:#3730a3; }
    #editor, .section-title:has(+ #editor) { display:none !important; }
  </style>
</head>
<body>
  <div id="sidebar">
    <div style="margin-bottom:12px;">
      <button id="homeBtn">Home View</button>
    </div>

    <div class="section-title">GOING TO THE MOVIES IN CLEVELAND, 1945</div>
    <div style="font-size:14px; line-height:1.45; margin-bottom:12px; color:#333;">
      It&rsquo;s August 1945. The war is ending, the lights are back on downtown, and Cleveland&rsquo;s theaters are buzzing with crowds.
      This interactive map lets you relive that moment.<br><br>
      Just tap a theater dot to see what was on the marquee: the films playing that week, the house itself, and&mdash;when available&mdash;a photo, address, and a bit of its history.<br><br>
      Close the window to return to the map and stroll to the next showplace. When your tour is done, step back to the map&rsquo;s beginning and imagine the city as it was&mdash;alive with moviegoing.
    </div>

    <div class="section-title">Search</div>
    <input id="filter" class="search" placeholder="Filter by theatre or film&hellip;" />

    <div class="btns">
      <button id="seedHome">Seed Home Area (z13â€“z15)</button>
      <button id="seedView">Save tiles in view</button>
      <button id="clearCache">Clear tile cache</button>
    </div>

    <div class="status" id="status">Loading&hellip;</div>
    <div id="list" class="list"></div>
  </div>

  <div id="map"></div>

  <!-- Leaflet + Axios -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>

  <!-- App logic -->
  <script>
  (function(){
    const HOME_CENTER = [41.4993, -81.6944];
    const HOME_ZOOM = 13;

    const map = L.map('map', { zoomControl: true }).setView(HOME_CENTER, HOME_ZOOM);

    const imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
    const refLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
    const refRoads  = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
    const hybrid = L.layerGroup([imagery, refLabels, refRoads]);

    const streets = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });

    hybrid.addTo(map);
    L.control.layers({ "Hybrid (Imagery + Labels)": hybrid, "Streets": streets }, null, { collapsed:false }).addTo(map);

    document.getElementById('homeBtn').addEventListener('click', () => {
      map.setView(HOME_CENTER, HOME_ZOOM);
      if (map.closePopup) map.closePopup();
    });

    const markers = [];
    const markerLayer = L.featureGroup().addTo(map);
    const listEl = document.getElementById('list');
    const statusEl = document.getElementById('status');
    const filterEl = document.getElementById('filter');

    function normalizeItem(raw, idx){
      if (!raw) return null;
      const lat = raw.lat ?? raw.latitude ?? raw.Lat ?? raw.Latitude;
      const lng = raw.lng ?? raw.lon ?? raw.longitude ?? raw.Lon ?? raw.Longitude;
      if (lat == null || lng == null) return null;
      const films = Array.isArray(raw.films) ? raw.films
                    : (typeof raw.films === 'string' ? raw.films.split(';').map(s => s.trim()).filter(Boolean) : []);
      const images = Array.isArray(raw.images) ? raw.images
                    : (typeof raw.images === 'string' ? raw.images.split('\\n').map(s => s.trim()).filter(Boolean) : []);
      return {
        id: raw.id ?? idx,
        name: (raw.name || raw.title || 'Untitled Theater').trim(),
        films,
        lat: Number(lat),
        lng: Number(lng),
        address: raw.address || '',
        notes: raw.notes || '',
        images
      };
    }

    function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/\"/g, '&quot;'); }

    function buildPopupHtml(item){
      const filmBadges = item.films.map(f => `<span class=\"badge\">${escapeHtml(f)}</span>`).join(' ');
      const imgHtml = item.images && item.images.length
        ? `<div style=\"margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;\">${
            item.images.slice(0,3).map(u => `<img src=\"${escapeAttr(u)}\" alt=\"\" style=\"width:90px; height:64px; object-fit:cover; border-radius:6px; border:1px solid #ddd\" />`).join('')
          }</div>`
        : '';
      return `
        <div class=\"title\" style=\"margin-bottom:4px;\">${escapeHtml(item.name)}</div>
        ${filmBadges ? `<div class=\"badges\">${filmBadges}</div>` : ''}
        <table class=\"details-table\" style=\"width:100%; border-collapse:collapse; margin-top:6px;\">
          ${item.address ? `<tr><th style=\"text-align:left; font-size:12px; color:#333; padding-right:6px;\">Address</th><td style=\"font-size:12px; color:#333;\">${escapeHtml(item.address)}</td></tr>` : ''}
          ${item.notes ? `<tr><th style=\"text-align:left; font-size:12px; color:#333; padding-right:6px;\">Notes</th><td style=\"font-size:12px; color:#333;\">${escapeHtml(item.notes)}</td></tr>` : ''}
        </table>
        ${imgHtml}
      `;
    }

    function addMarker(item){
      const m = L.marker([item.lat, item.lng]);
      m.bindPopup(buildPopupHtml(item), { maxWidth: 320 });
      m._item = item;
      m.addTo(markerLayer);
      markers.push(m);
    }

    function renderList(items){
      listEl.innerHTML = '';
      items.forEach((it) => {
        const div = document.createElement('div');
        div.className = 'item';
        const filmsLine = it.films.join('; ');
        div.innerHTML = `
          <div class=\"title\">${escapeHtml(it.name)}</div>
          ${filmsLine ? `<div class=\"small\">${escapeHtml(filmsLine)}</div>` : ''}
          ${it.address ? `<div class=\"small\">${escapeHtml(it.address)}</div>` : ''}
        `;
        div.addEventListener('click', () => {
          map.setView([it.lat, it.lng], Math.max(map.getZoom(), 15));
          const mm = markers.find(m => m._item && m._item.id === it.id);
          if (mm) mm.openPopup();
        });
        listEl.appendChild(div);
      });
      statusEl.textContent = items.length ? `${items.length} theaters` : 'No theaters found.';
    }

    function applyFilter(){
      const q = (filterEl.value || '').toLowerCase().trim();
      const filtered = markers
        .map(m => m._item)
        .filter(it => {
          if (!q) return true;
          const hay = [ it.name, it.address || '', (it.films || []).join(' ') ].join(' ').toLowerCase();
          return hay.includes(q);
        });
      renderList(filtered);
    }

    async function loadData(){
      try {
        const tag = document.getElementById('inline-data');
        if (tag && tag.textContent.trim()) {
          const arr = JSON.parse(tag.textContent);
          return Array.isArray(arr) ? arr : (arr.items || []);
        }
        if (Array.isArray(window.MAP_DATA)) return window.MAP_DATA;
        const res = await fetch('theaters.json', { cache:'no-cache' });
        if (res.ok) {
          const data = await res.json();
          return Array.isArray(data) ? data : (data.items || []);
        }
      } catch (e) {
        console.warn('Data load error:', e);
      }
      return [
        { id: 1, name: 'Allen Theatre (Sample)', films: 'Example Film A; Example Film B', lat: 41.501, lng: -81.690, address: '1407 Euclid Ave', notes: 'Sample only; replace with real data.', images: [] }
      ];
    }

    (async function initPoints(){
      const raw = await loadData();
      const items = raw.map((r, i) => normalizeItem(r, i)).filter(Boolean);
      if (!items.length) {
        statusEl.textContent = 'No data found (add theaters.json or MAP_DATA).';
        return;
      }
      items.forEach(addMarker);
      renderList(items);
      try { map.fitBounds(markerLayer.getBounds().pad(0.1), { maxZoom: HOME_ZOOM }); } catch(e){}
    })();

    filterEl.addEventListener('input', applyFilter);

    // ---- SW registration (GitHub Pages safe) ----
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        var basePath = (function () {
          var p = location.pathname;
          if (p.endsWith('.html')) p = p.slice(0, p.lastIndexOf('/') + 1);
          if (!p.endsWith('/')) p += '/';
          var parts = p.split('/').filter(Boolean);
          if (parts.length > 0) return '/' + parts[0] + '/';
          return '/';
        })();

        var swUrl =
          location.hostname === 'localhost' || location.hostname === '127.0.0.1'
            ? './sw-cle-tiles.js'
            : basePath + 'sw-cle-tiles.js';

        var scope =
          location.hostname === 'localhost' || location.hostname === '127.0.0.1'
            ? './'
            : basePath;

        navigator.serviceWorker
          .register(swUrl, { scope: scope })
          .then(reg => console.log('ServiceWorker registered:', reg.scope))
          .catch(err => console.warn('ServiceWorker registration failed:', err));
      });
    }
  })();
  </script>

  <!-- Inline sample data so list shows even if theaters.json is missing -->
  <script id="inline-data" type="application/json">
  [
    {
      "id": 1,
      "name": "Allen Theatre (Sample)",
      "films": "Double Feature A; Matinee B",
      "lat": 41.501,
      "lng": -81.690,
      "address": "1407 Euclid Ave",
      "notes": "Sample row. Replace with your real data via theaters.json or window.MAP_DATA.",
      "images": []
    }
  ]
  </script>
</body>
</html>
